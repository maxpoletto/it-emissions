<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Emissions Calculator</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const MODEL_VERSION = "1.0";
        const MODEL_DESCRIPTION = "UZH IT Emissions Model";

        // Globals
        let stochastic = false;
        let percentage = false;
        let devices = {};
        let emissionsIntensity = {};
        let cloudInstances = 0;
        let llmQueries = null;
        let deviceChart = null;
        let llmChart = null;

        let resultsEmissions = null;
        let resultsLLMGrowth = null;

        const deviceInfoDefault = {
            'Laptops': {
                'Lifetime': 4,
                'Count': 32000,
                'Days per year': 250,
            },
            'Monitors': {
                'Lifetime': 6,
                'Count': 10325,
                'Days per year': 250,
            },
            'Desktops': {
                'Lifetime': 6,
                'Count': 0,
                'Days per year': 250,
            },
            'Servers': {
                'Lifetime': 5,
                'Count': 1121,
                'Days per year': 365,
            },
            'Mobile phones': {
                'Lifetime': 3,
                'Count': 35000,
                'Days per year': 250,
            },
            'A/V equipment': {
                'Lifetime': 6,
                'Count': 431,
                'Days per year': 250,
            },
            'Printers': {
                'Lifetime': 6,
                'Count': 333,
                'Days per year': 250,
            },
        };
        let deviceInfo = {};

        const embodiedEmissionsKgCo2eDefault = {
            'Laptops': {
                'Mean': 180, // Split the difference between Rarecoil and Ecoinvent.
                'Stdev': 128,
                'Min': 104,
                'Max': 372,
            },
            'Monitors': {
                'Mean': 340, // Precise: 344
                'Stdev': 50,
                'Min': 150,
                'Max': 394,
            },
            'Desktops': {
                'Mean': 290, // Precise: 289
                'Stdev': 80,
                'Min': 209,
                'Max': 403,
            },
            'Servers': {
                'Mean': 1100, // Dell mean 1252, Boazvizta ~900
                'Stdev': 330,
                'Min': 383,
                'Max': 1582,
            },
            'Mobile phones': {
                'Mean': 50,
                'Stdev': 10,
                'Min': 30,
                'Max': 70,
            },
            'A/V equipment': {
                'Mean': 700, // Precise: 753
                'Stdev': 109,
                'Min': 644,
                'Max': 862,
            },
            'Printers': {
                'Mean': 1100, // Precise: 1167
                'Stdev': 200,
                'Min': 967,
                'Max': 1367,
            },
        };
        let embodiedEmissionsKgCo2e = {};

        const powerWDefault = {
            'Laptops': {
                'Mean': 50,
                'Stdev': 20,
                'Min': 20,
                'Max': 100,
                'Standby': 1,
            },
            'Monitors': {
                'Mean': 50,
                'Stdev': 10,
                'Min': 30,
                'Max': 90,
                'Standby': 1,
            },
            'Desktops': {
                'Mean': 100,
                'Stdev': 20,
                'Min': 60,
                'Max': 200,
                'Standby': 1,
            },
            'Servers': {
                'Mean': 400,
                'Stdev': 100,
                'Min': 200,
                'Max': 600,
                'Standby': 1,
            },
            'Mobile phones': {
                'Mean': 15,
                'Stdev': 2,
                'Min': 5,
                'Max': 20,
                'Standby': 0,
            },
            'A/V equipment': {
                'Mean': 250,
                'Stdev': 50,
                'Min': 150,
                'Max': 350,
                'Standby': 1,
            },
            'Printers': {
                'Mean': 1000,
                'Stdev': 200,
                'Min': 600,
                'Max': 1400,
                'Standby': 90,
            },
        };
        let powerW = {};

        const computeDefault = {
            'Campus networking overhead %': 10,
            'Campus data center PUE x100': 200,
            'Cloud PUE x100': 115,
            'Cloud % servers in cloud': 0,
            'Cloud instances per 100 local servers': 100,
            'Cloud instance embodied kg': 700,
            'Cloud instance power W': 300,
            'Cloud instance lifetime y': 4,
            'Supercomputing mean power kW': 66,
        };
        let compute = {};

        const llmsDefault = {
            'User population': 38000,
            'Mean daily user queries': 15,
            'Days per year': 250,
            'Mean query Wh': 1.0,
            'Training overhead %': 25,
            'Emissions intensity g CO2e / kWh': 207,
            'Embodied emissions g CO2e / query': 0.1,
            'Annual usage growth %': 50,
            'Annual efficiency growth %': 30,
            'Annual training growth %': 50,
        };
        let llms = {};

        const dutyCycle6hDefault = {
            // Fraction of time active during 0:00-5:59, 6:00-11:59, 12:00-17:59, 18:00-23:59.
            // Just a guess, but probably not unreasonable.
            'Laptops': [0.1, 0.5, 1.0, 0.3],
            'Desktops': [0.1, 0.5, 1.0, 0.3],
            'Servers': [0.8, 0.8, 0.8, 0.8],
            'Mobile phones': [0.0, 0.0, 0.0, 0.5],
            'Monitors': [0.1, 0.5, 1.0, 0.3],
            'A/V equipment': [0.0, 0.3, 0.6, 0.1],
            'Printers': [0.0, 0.0, 0.01, 0.0],
        };
        let dutyCycle6h = {};

        // Tooltip definitions
        const tooltips = {
            columnHeaders: {
                'Count': 'Number of devices',
                'Lifetime': 'Average lifetime (y)',
                'Days per year': 'Days per year the device is used',
                'Mean': 'Mean value',
                'Stdev': 'Standard deviation',
                'Min': 'Minimum value',
                'Max': 'Maximum value',
                'Standby': 'Standby power (W)'
            },
            parameters: {
                'Campus networking overhead %': 'Campus networking energy use as percentage (x100) of energy used by laptop, desktops, and servers',
                'Campus data center PUE x100': 'Power usage effectiveness of campus data center (x100)',
                'Cloud PUE x100': 'Power usage effectiveness of cloud (x100)',
                'Cloud % servers in cloud': 'Percentage of campus servers that are migrated to cloud',
                'Cloud instances per 100 local servers': 'Number of cloud instances required to replace 100 campus servers',
                'Cloud instance embodied kg': 'Embodied emissions of a cloud instance (kg CO2e)',
                'Cloud instance power W': 'Power consumption of a cloud instance (W)',
                'Cloud instance lifetime y': 'Average lifetime of a cloud instance (y)',
                'Supercomputing mean power kW': 'Mean power consumption of workloads at supercomputing facility (kW)',
                'User population': 'Number of users',
                'Mean daily user queries': 'Mean number of queries per user per day',
                'Days per year': 'Days per year average user uses LLMs',
                'Mean query Wh': 'Mean energy consumption of a query (Wh)',
                'Training overhead %': 'Energy used for training as percentage of energy used for inference',
                'Emissions intensity g CO2e / kWh': 'Emissions intensity of electricity (g CO2e / kWh) for LLM facility',
                'Embodied emissions g CO2e / query': 'Embodied emissions per query (g CO2e)',
                'Annual usage growth %': 'Annual growth rate of LLM usage',
                'Annual efficiency growth %': 'Annual growth rate of LLM inference efficiency',
                'Annual training growth %': 'Annual growth rate of LLM training overhead',
            }
        };

        // Per-country emissions intensity (g CO2e / kWh). Only CH for now.
        class Emissions {
            static gco2PerKwhByHours = {
                'ch': [63, 58, 58, 52, 49, 47, 45, 45, 49, 54, 62, 63]
            };

            static atHour(hour, country) {
                return this.gco2PerKwhByHours[country][Math.floor(hour / 2)];
            }

            static mean(country) {
                const values = this.gco2PerKwhByHours[country];
                return values.reduce((a, b) => a + b, 0) / values.length;
            }
        }
    </script>
    <style>
        .emissions-calculator {
            max-width: 820px !important;
            margin: 10px auto;
            padding: 20px;
        }

        .header-with-logo {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .uzh-logo {
            height: 4rem;
            width: auto;
            flex-shrink: 2;
            margin-right: 1rem;
        }

        .header-title {
            flex: 1;
            text-align: center;
            font-size: 1.8rem;
            line-height: 1.2;
            font-weight: 600;
            margin: 0;
            color: rgba(var(--c-black), 1);
        }

        .intro-text {
            margin-bottom: 30px;
        }

        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid rgba(var(--c-grey), 0.2);
            border-radius: 8px;
            background: rgba(var(--c-white), 1);
        }

        .section-title {
            font-weight: 600;
            color: rgba(var(--c-black), 1);
            margin-bottom: 1rem;
        }
        h2.section-title {
            font-size: 1.2rem;
            line-height: 1.2;
        }
        h1.section-title {
            font-size: 2rem;
            line-height: 1.5;
            background-color: rgba(var(--c-grey-light), 0.5);
        }

        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .parameter-table th,
        .parameter-table td {
            border: 1px solid rgba(var(--c-grey), 0.2);
            padding: 0.5rem;
            vertical-align: middle;
        }
        .parameter-table th:first-child,
        .parameter-table td:first-child {
            text-align: left;
            width: 40%;
            min-width: 100px;
            text-wrap: pretty;
        }
        .parameter-table th:not(:first-child),
        .parameter-table td:not(:first-child) {
            text-align: right;
            width: auto;
        }
        .parameter-table th {
            background-color: rgba(var(--c-grey-light), 0.5);
            font-weight: 600;
            font-size: 1rem;
            line-height: 1.4;
        }
        .parameter-table td:first-child {
            text-align: left;
            font-weight: 600;
            background-color: rgba(var(--c-grey-light), 0.5);
        }
        /* Hide the up/down arrows in numeric input fields */
        .parameter-table input::-webkit-outer-spin-button,
        .parameter-table input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Do the same for Firefox */
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        .parameter-table input {
            width: 100%;
            border: none;
            padding: 0.25rem 0.25rem 0.25rem 0.25rem;
            text-align: right;
            background: transparent;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .parameter-table input:focus {
            background-color: rgba(var(--c-grey-light), 0.5);
            outline: none;
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin: 2rem 0;
            padding: 1rem;
            background-color: rgba(var(--c-grey-light), 0.5);
            border-radius: 8px;
        }

        #percentage-checkbox {
            margin-right: 0.25rem;
        }

        .results-section {
            margin-top: 20px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th,
        .results-table td {
            border: 1px solid rgba(var(--c-grey), 0.2);
            padding: 0.75rem;
        }
        .results-table th:first-child,
        .results-table td:first-child {
            text-align: left;
            width: 40%;
        }
        .results-table th:not(:first-child),
        .results-table td:not(:first-child) {
            text-align: right;
            width: 30%; /* Two columns with values, 30% each */
        }
        .results-table th {
            background-color: rgba(var(--c-grey-light), 0.5);
            font-weight: 600;
        }
        .results-table tr:last-child td {
            font-weight: 600;
            background-color: rgba(var(--c-blue), 0.05);
        }

        .chart-container {
            width: 100%;
            min-width: 450px;
            height: 500px;
            margin-top: 0;
            margin-bottom: 1rem;
            padding: 1.5rem;
            background: rgba(var(--c-white), 1);
            border: 1px solid rgba(var(--c-grey), 0.2);
            border-radius: 0.5rem;
        }
        .one-column {
            display: grid;
            grid-template-columns: 1fr;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media(max-width: 550px) {
            .two-column {
                grid-template-columns: 1fr;
                gap: 0;
            }
        }
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
        }

        /* Use site's button styles */
        .run-btn {
            background-color: rgba(var(--c-blue), 1);
            color: rgba(var(--c-white), 1);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 100px;
            cursor: pointer;
            line-height: 1.5;
            font-weight: 400;
            transition: background-color 0.2s ease-in-out;
        }

        .run-btn:hover {
            background-color: rgba(var(--c-blue), 0.8);
        }

        /* Collapsible table functionality */
        .expand-toggle {
            background: none;
            border: none;
            font-size: 1rem;
            color: rgba(var(--c-blue), 1);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            user-select: none;
        }

        .expand-toggle:hover {
            background-color: rgba(var(--c-blue), 0.1);
        }

        .expand-toggle:focus {
            outline: 2px solid rgba(var(--c-blue), 0.5);
        }

        .additional-columns {
            display: none;
        }

        .additional-columns.visible {
            display: table-cell;
        }

        /* Tooltip system */
        [data-tooltip] {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted rgba(var(--c-grey), 0.5);
        }

        [data-tooltip]:not([data-tooltip=""]):hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(var(--c-black), 0.9);
            color: rgba(var(--c-white), 1);
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            line-height: 1.3;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        [data-tooltip]:not([data-tooltip=""]):hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            border: 4px solid transparent;
            border-top-color: rgba(var(--c-black), 0.9);
            z-index: 999;
            pointer-events: none;
        }

        .additional-headers {
            display: none;
        }

        .additional-headers.visible {
            display: table-cell;
        }
    </style>
</head>
<body>
    <main>
        <div class="emissions-calculator">
            <div class="header-with-logo">
                <img src="assets/uzh_logo.svg" alt="UZH Logo" class="uzh-logo">
                <h1 class="header-title">IT Emissions Calculator</h1>
            </div>
            <div class="intro-text">
                <p>
                    This calculator estimates the carbon emissions of IT infrastructure at the University of ZÃ¼rich.
                </p>
                <p>
                    The model should be generally applicable to other similar campuses. Edit any of the parameters below to explore different scenarios.</p>
                <p>
                    For more details, see <a href="https://github.com/maxpoletto/it-emissions">https://github.com/maxpoletto/it-emissions</a>.
                </p>
            </div>
            <!-- Device Population - Full Width Row -->
            <div class="one-column">
                <div class="input-section">
                    <h2 class="section-title">Device Population</h2>
                    <table class="parameter-table" id="device-table"></table>
                </div>
            </div>

            <!-- Two column layout for Embodied Emissions and Power Consumption -->
            <div class="two-column">
                <div class="input-section">
                    <h2 class="section-title">Embodied Emissions (kg CO2e)</h2>
                    <table class="parameter-table" id="embodied-table"></table>
                </div>

                <div class="input-section">
                    <h2 class="section-title">Power Consumption (W)</h2>
                    <table class="parameter-table" id="power-table"></table>
                </div>
            </div>

            <div class="one-column">
                <!-- Compute Parameters - Full Width Row -->
                <div class="input-section">
                    <h2 class="section-title">Compute Parameters</h2>
                    <table class="parameter-table" id="compute-table"></table>
                </div>

                <!-- LLM Parameters - Full Width Row -->
                <div class="input-section">
                    <h2 class="section-title">LLM Parameters</h2>
                    <table class="parameter-table" id="llm-table"></table>
                </div>

                <!-- Duty Cycles -->
                <div class="input-section">
                    <h2 class="section-title">Device Duty Cycles (fraction of time active)
                        <button class="expand-toggle" onclick="toggleDutyCycleTable()" id="duty-cycle-toggle">&gt;&gt;</button>
                    </h2>
                    <table class="parameter-table" id="duty-cycle-table" style="display: none;"></table>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="run-btn" onclick="updateModel()">Rerun Calculation</button>
                <button class="run-btn" onclick="resetParameters()">Reset Parameters</button>
                <button class="run-btn" onclick="exportResults()">Export Results</button>
            </div>

            <!-- Results Section -->
            <h1 class="section-title">Results</h1>
            <div class="results-controls">
                <input type="checkbox" id="percentage-checkbox" onchange="togglePercentage()">
                <label for="percentage-checkbox">Show as percentages</label>
            </div>
            <!-- Results Table - Full Width -->
            <div class="results-section">
                <table class="results-table" id="results-table">
                    <thead id="results-thead">
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                    <tfoot id="results-tfoot">
                    </tfoot>
                </table>
            </div>

            <!-- Charts - Stacked Vertically -->
            <div class="results-section">
                <div class="chart-container">
                    <canvas id="emissions-chart"></canvas>
                </div>
            </div>
            <div class="results-section">
                <div class="chart-container">
                    <canvas id="llm-projection-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Returns a list of n values from a truncated normal distribution.
        // If stochastic is false, returns a list of n values all equal to mu.
        function truncatedNormal(mu, sigma, minValue, maxValue, n) {
            if (n === 0) return [];
            if (!stochastic) return Array(1).fill(n * mu);

            const results = [];
            let value;
            for (let i = 0; i < n; i++) {
                do {
                    // Box-Muller transform for normal distribution
                    // https://stackoverflow.com/questions/25582882/javascript-math-random-normal-distribution-gaussian-bell-curve
                    const u = 1 - Math.random(); // Tranform [0, 1) to (0, 1] to not break Math.log.
                    const v = Math.random();
                    const z = Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
                    value = mu + sigma * z;
                } while (value < minValue || value > maxValue);
                results.push(Math.floor(value));
            }
            return results;
        }

        // Generate multi-column collapsible input tables
        function createCollapsibleTable(tableId, data, all_params, default_display_params, callback) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';

            // Check that each row of data contains all_params
            Object.keys(data).forEach(key => {
                all_params.forEach(param => {
                    if (!data[key].hasOwnProperty(param)) {
                        throw new Error(`Data does not contain parameter ${param}`);
                    }
                });
            });

            // Headers for all_params, but only display default_display_params
            const headerRow = document.createElement('tr');
            headerRow.appendChild(document.createElement('th')); // Empty cell for row
            all_params.forEach(param => {
                const th = document.createElement('th');
                th.textContent = param;

                // Add tooltip if defined (even if empty, for visual indication)
                if (tooltips.columnHeaders.hasOwnProperty(param)) {
                    th.setAttribute('data-tooltip', tooltips.columnHeaders[param]);
                }

                headerRow.appendChild(th);
                if (!default_display_params.includes(param)) {
                    th.className = 'additional-headers';
                }
            });
            table.appendChild(headerRow);

            // Create rows
            Object.keys(data).forEach(key => {
                const row = document.createElement('tr');

                // Row name cell
                const deviceCell = document.createElement('td');
                deviceCell.textContent = key;
                row.appendChild(deviceCell);

                all_params.forEach(param => {
                    const cell = document.createElement('td');
                    if (!default_display_params.includes(param)) {
                        cell.className = 'additional-columns';
                    }
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = data[key][param] || 0;
                    input.addEventListener('change', (e) => {
                        data[key][param] = parseFloat(e.target.value) || 0;
                        if (callback) callback();
                    });
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                table.appendChild(row);
            });
        }

        // Create key-value input tables
        function createKeyValueTable(tableId, data, callback) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';

            // Create header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Parameter</th><th>Value</th>';
            table.appendChild(headerRow);

            // Create rows for each parameter
            Object.keys(data).forEach(paramKey => {
                const row = document.createElement('tr');

                // Parameter name cell
                const keyCell = document.createElement('td');
                keyCell.textContent = paramKey;

                // Add tooltip if defined (even if empty, for visual indication)
                if (tooltips.parameters.hasOwnProperty(paramKey)) {
                    keyCell.setAttribute('data-tooltip', tooltips.parameters[paramKey]);
                }

                row.appendChild(keyCell);

                // Value input cell
                const valueCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.value = data[paramKey];
                input.addEventListener('change', (e) => {
                    data[paramKey] = parseFloat(e.target.value) || 0;
                    if (callback) callback();
                });
                valueCell.appendChild(input);
                row.appendChild(valueCell);

                table.appendChild(row);
            });
        }

        // Create duty cycle table with 4 time periods per device
        function createDutyCycleTable(tableId, data, callback) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';

            const timePeriods = ['Night (0:00-5:59)', 'Morning (6:00-11:59)', 'Afternoon (12:00-17:59)', 'Evening (18:00-23:59)'];

            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.appendChild(document.createElement('th')); // Empty cell for device names

            timePeriods.forEach(period => {
                const th = document.createElement('th');
                th.textContent = period;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // Create rows for each device type
            Object.keys(data).forEach(deviceType => {
                const row = document.createElement('tr');

                // Device name cell
                const deviceCell = document.createElement('td');
                deviceCell.textContent = deviceType;
                row.appendChild(deviceCell);

                // Create input for each time period
                data[deviceType].forEach((value, index) => {
                    const cell = document.createElement('td');

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.min = '0';
                    input.max = '1';
                    input.value = value;
                    input.addEventListener('change', (e) => {
                        const newValue = parseFloat(e.target.value);
                        if (newValue >= 0 && newValue <= 1) {
                            data[deviceType][index] = newValue;
                            if (callback) callback();
                        } else {
                            e.target.value = value; // Reset to previous value if invalid
                        }
                    });

                    cell.appendChild(input);
                    row.appendChild(cell);
                });

                table.appendChild(row);
            });
        }

        function toggleTableExpansion(tableId) {
            const table = document.getElementById(tableId);
            const toggle = document.getElementById(tableId.replace('-table', '-toggle'));

            const additionalHeaders = table.querySelectorAll('.additional-headers');
            const additionalColumns = table.querySelectorAll('.additional-columns');

            const isExpanded = additionalHeaders.length > 0 && additionalHeaders[0].classList.contains('visible');

            if (isExpanded) {
                // Collapse
                additionalHeaders.forEach(el => el.classList.remove('visible'));
                additionalColumns.forEach(el => el.classList.remove('visible'));
                toggle.textContent = '>>';
            } else {
                // Expand
                additionalHeaders.forEach(el => el.classList.add('visible'));
                additionalColumns.forEach(el => el.classList.add('visible'));
                toggle.textContent = '<<';
            }
        }

        function toggleDutyCycleTable() {
            const table = document.getElementById('duty-cycle-table');
            const toggle = document.getElementById('duty-cycle-toggle');

            if (table.style.display === 'none') {
                // Show table
                table.style.display = '';
                toggle.textContent = '<<';
            } else {
                // Hide table
                table.style.display = 'none';
                toggle.textContent = '>>';
            }
        }

        function togglePercentage() {
            percentage = !percentage;
            renderEmissionsTable()
            updateURL();
        }

        function exportResults() {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    modelVersion: MODEL_VERSION,
                    description: MODEL_DESCRIPTION
                },
                parameters: {
                    deviceInfo: deviceInfo,
                    embodiedEmissionsKgCo2e: embodiedEmissionsKgCo2e,
                    powerW: powerW,
                    dutyCycle6h: dutyCycle6h,
                    compute: compute,
                    llms: llms
                },
                settings: {
                    percentage: percentage,
                    stochastic: stochastic
                },
                results: {
                    data: resultsEmissions.slice(0, -1),
                    summary: {
                        totalEmbodied: Math.round(resultsEmissions[resultsEmissions.length - 1].embodied),
                        totalUsage: Math.round(resultsEmissions[resultsEmissions.length - 1].usage),
                        totalCombined: Math.round(resultsEmissions[resultsEmissions.length - 1].embodied + resultsEmissions[resultsEmissions.length - 1].usage)
                    }
                }
            };

            // Create and download JSON file
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `it-emissions-model-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createInputTables() {
            createCollapsibleTable('device-table', deviceInfo, ['Count', 'Lifetime', 'Days per year'], ['Count', 'Lifetime', 'Days per year'], updateModel);
            createCollapsibleTable('embodied-table', embodiedEmissionsKgCo2e, ['Mean', 'Stdev', 'Min', 'Max'], ['Mean'], updateModel);
            createCollapsibleTable('power-table', powerW, ['Mean', 'Stdev', 'Min', 'Max', 'Standby'], ['Mean', 'Standby'], updateModel);
            createDutyCycleTable('duty-cycle-table', dutyCycle6h, updateModel);
            createKeyValueTable('compute-table', compute, updateModel);
            createKeyValueTable('llm-table', llms, updateModel);
        }

        function deviceEmissionsIntensity(device) {
            const dutyCycle = dutyCycle6h[device];
            const r = Math.floor(24 / dutyCycle.length);
            const ei = [];
            for (let i = 0; i < 24; i++) {
                const cycleIndex = Math.floor(i / r);
                const duty = dutyCycle[cycleIndex];
                const emission = Emissions.atHour(i, 'ch');
                ei.push(duty * emission);
            }
            return ei;
        }

        function averageEmissionsKgCO2ePerDay(powerW) {
            return Emissions.mean('ch') / 1000 * (powerW / 1000) * 24; // (g CO2e / kWh) / 1000 * kW * 24 h = kg CO2e / day
        }

        // Generate device instances
        function generateDevices() {
            devices = {};
            emissionsIntensity = {};

            Object.keys(deviceInfo).forEach(device => {
                devices[device] = {};

                let n = deviceInfo[device]['Count'];
                if (device === 'Servers') {
                    cloudInstances = Math.floor(compute['Cloud % servers in cloud'] * n / 100);
                    n -= cloudInstances;
                }

                const stats = embodiedEmissionsKgCo2e[device];
                devices[device]['annual_embodied_emissions'] = truncatedNormal(
                    stats['Mean'], stats['Stdev'], stats['Min'], stats['Max'], n
                ).map(x => x / deviceInfo[device]['Lifetime']);

                devices[device]['power_w'] = truncatedNormal(
                    powerW[device]['Mean'], powerW[device]['Stdev'],
                    powerW[device]['Min'], powerW[device]['Max'], n
                );

                devices[device]['standby_w'] = Array(n).fill(powerW[device]['Standby']);
                emissionsIntensity[device] = deviceEmissionsIntensity(device);
            });
        }

        // Calculate device emissions
        function deviceEmissionsKgCO2e(device) {
            const intensitySum = emissionsIntensity[device].reduce((a, b) => a + b, 0); // g CO2e (for 24 h for 1 kW * duty cycle)
            const powerSum = devices[device]['power_w'].reduce((a, b) => a + b, 0); // W for all devices
            const u = powerSum * intensitySum * deviceInfo[device]['Days per year'] / (1000 * 1000); // convert to kg CO2e / year
            const m = devices[device]['annual_embodied_emissions'].reduce((a, b) => a + b, 0);
            return [u, m];
        }

        // Calculate data center cooling emissions
        function dataCenterCoolingEmissionsKgCO2e() {
            const [serverU, _] = deviceEmissionsKgCO2e('Servers');
            const dcCoolingU = serverU * (compute['Campus data center PUE x100'] - 100) / 100;
            return dcCoolingU;
        }

        // Calculate cloud emissions
        function cloudEmissionsKgCO2e() {
            const u = cloudInstances * compute['Cloud instances per 100 local servers'] / 100
                * averageEmissionsKgCO2ePerDay(compute['Cloud instance power W']) * 365
                * compute['Cloud PUE x100'] / 100;
            const m = cloudInstances * compute['Cloud instances per 100 local servers'] / 100
                * compute['Cloud instance embodied kg'] / compute['Cloud instance lifetime y'];
            return [u, m];
        }

        // Calculate supercomputing emissions
        function supercomputingEmissionsKgCO2e() {
            return averageEmissionsKgCO2ePerDay(compute['Supercomputing mean power kW'] * 1000) * 365;
        }

        // Calculate LLM emissions
        function llmEmissionsKgCO2e() {
            const emissionsIntensity = llms['Emissions intensity g CO2e / kWh'];
            const nqueries = llms['Mean daily user queries'] * llms['User population'];
            // Divide by 1000 to convert Wh to kWh and by 1000 again to convert g CO2e to kg CO2e.
            const u = nqueries * llms['Days per year'] * llms['Mean query Wh'] * emissionsIntensity / (1000 * 1000);
            const m = u * llms['Training overhead %'] / 100 + nqueries * llms['Embodied emissions g CO2e / query'] / 1000;
            return [u, m];
        }

        // Calculate LLM emissions projection over 5 years
        function llmEmissionsProjection() {
            const baseUsage = llms['Mean daily user queries'] * llms['User population'];
            const baseEnergyPerQuery = llms['Mean query Wh'];
            const emissionsIntensity = llms['Emissions intensity g CO2e / kWh'];
            const trainingOverhead = llms['Training overhead %'] / 100;
            const usageGrowth = llms['Annual usage growth %'] / 100;
            const efficiencyGrowth = llms['Annual efficiency growth %'] / 100;
            const trainingGrowth = llms['Annual training growth %'] / 100;

            let usage = baseUsage;
            let embodiedEmissions = 0;
            let energyPerQuery = baseEnergyPerQuery;
            const projection = [];
            for (let year = 0; year < 5; year++) {
                const usageEmissions = usage * llms['Days per year'] * energyPerQuery * emissionsIntensity / (1000 * 1000);
                if (year === 0) {
                    embodiedEmissions = usageEmissions * trainingOverhead;
                } else {
                    embodiedEmissions = embodiedEmissions * (1 + trainingGrowth);
                }
                const totalEmissions = usageEmissions + embodiedEmissions;

                projection.push({
                    year: new Date().getFullYear() + year,
                    usage: usageEmissions,
                    embodied: embodiedEmissions,
                    total: totalEmissions
                });

                usage *= 1 + usageGrowth;
                energyPerQuery *= 1 - efficiencyGrowth;
            }

            return projection;
        }

        function runModel() {
            generateDevices();

            let totalU = 0, totalM = 0;
            const data = [];

            // Device emissions
            Object.keys(deviceInfo).forEach(device => {
                const [u, m] = deviceEmissionsKgCO2e(device);
                totalU += u;
                totalM += m;
                data.push({
                    category: device,
                    embodied: m,
                    usage: u
                });
            });

            // Campus networking overhead
            let nu = 0, nm = 0;
            ['Laptops', 'Desktops', 'Servers'].forEach(device => {
                const [u, m] = deviceEmissionsKgCO2e(device);
                nu += u * compute['Campus networking overhead %'] / 100;
                nm += m * compute['Campus networking overhead %'] / 100;
            });
            totalU += nu;
            totalM += nm;
            data.push({
                category: 'Campus networking',
                embodied: nm,
                usage: nu
            });

            // DC cooling
            const dcCoolingU = dataCenterCoolingEmissionsKgCO2e();
            data.push({
                category: 'DC cooling',
                embodied: null,
                usage: dcCoolingU
            });
            totalU += dcCoolingU;

            // Cloud
            const [cloudU, cloudM] = cloudEmissionsKgCO2e();
            data.push({
                category: 'Cloud',
                embodied: cloudM,
                usage: cloudU
            });
            totalU += cloudU;
            totalM += cloudM;

            // Supercomputing
            const supercomputingU = supercomputingEmissionsKgCO2e();
            data.push({
                category: 'Supercomputing',
                embodied: null,
                usage: supercomputingU
            });
            totalU += supercomputingU;

            // LLM
            const [llmU, llmM] = llmEmissionsKgCO2e();
            data.push({
                category: 'LLM',
                embodied: llmM,
                usage: llmU
            });
            totalU += llmU;
            totalM += llmM;

            // Total
            data.push({
                category: 'Totals',
                embodied: totalM,
                usage: totalU
            });
            resultsEmissions = data;
            resultsLLMGrowth = llmEmissionsProjection();
        }

        function renderEmissionsTable() {
            const data = resultsEmissions;
            const thead = document.getElementById('results-thead');
            thead.innerHTML = '';
            thead.innerHTML = `
                <tr>
                    <th>Category</th>
                    <th>Embodied<br>(${percentage ? '%' : 'kg CO2e'})</th>
                    <th>Usage<br>(${percentage ? '%' : 'kg CO2e'})</th>
                </tr>
            `;

            const totalsRow = data[data.length - 1];
            const combined = Math.round(totalsRow.embodied + totalsRow.usage);

            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.category}</td>
                    <td>${row.embodied !== null ? (percentage ? Math.round(row.embodied / combined * 100) : Math.round(row.embodied)) : ''}</td>
                    <td>${percentage ? Math.round(row.usage / combined * 100) : Math.round(row.usage)}</td>
                `;
                tbody.appendChild(tr);
            });

            const tfoot = document.getElementById('results-tfoot');
            tfoot.innerHTML = `
                <tr><td>Combined total</td><td colspan="2">${percentage ? Math.round(combined / combined * 100) : Math.round(combined)}</td></tr>
            `;
        }

        function renderEmissionsChart() {
            const data = resultsEmissions.slice(0, -1);
            const ctx = document.getElementById('emissions-chart').getContext('2d');

            if (deviceChart) {
                deviceChart.destroy();
            }

            const labels = data.map(d => d.category);
            const embodiedData = data.map(d => d.embodied || 0);
            const usageData = data.map(d => d.usage || 0);

            deviceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Embodied (kg CO2e/y)',
                        data: embodiedData,
                        backgroundColor: 'rgba(0, 40, 165, 0.8)',
                        borderColor: 'rgba(0, 40, 165, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Usage (kg CO2e)',
                        data: usageData,
                        backgroundColor: 'rgba(0, 40, 165, 0.5)',
                        borderColor: 'rgba(0, 40, 165, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'CO2e Emissions Breakdown',
                            font: {
                                size: 16,
                                weight: 600
                            }
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Category'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'kg CO2e'
                            }
                        }
                    }
                }
            });
        }

        function renderLLMChart() {
            const ctx = document.getElementById('llm-projection-chart').getContext('2d');

            if (llmChart) {
                llmChart.destroy();
            }

            const projectionData = resultsLLMGrowth;
            const labels = projectionData.map(d => d.year.toString());
            const embodiedData = projectionData.map(d => Math.round(d.embodied));
            const usageData = projectionData.map(d => Math.round(d.usage));

            llmChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Training/Embodied (kg CO2e/y)',
                        data: embodiedData,
                        backgroundColor: 'rgba(0, 40, 165, 0.8)',
                        borderColor: 'rgba(0, 40, 165, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Usage (kg CO2e/y)',
                        data: usageData,
                        backgroundColor: 'rgba(0, 40, 165, 0.5)',
                        borderColor: 'rgba(0, 40, 165, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'LLM Emissions 5-Year Projection',
                            font: {
                                size: 16,
                                weight: 600
                            }
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'kg CO2e/year'
                            }
                        }
                    }
                }
            });
        }

        function renderOutput() {
            document.getElementById('percentage-checkbox').checked = percentage;
            renderEmissionsTable();
            renderEmissionsChart();
            renderLLMChart();
        }

        function resetParameters() {
            deviceInfo = JSON.parse(JSON.stringify(deviceInfoDefault));
            embodiedEmissionsKgCo2e = JSON.parse(JSON.stringify(embodiedEmissionsKgCo2eDefault));
            powerW = JSON.parse(JSON.stringify(powerWDefault));
            compute = JSON.parse(JSON.stringify(computeDefault));
            llms = JSON.parse(JSON.stringify(llmsDefault));
            dutyCycle6h = JSON.parse(JSON.stringify(dutyCycle6hDefault));
            percentage = false;

            createInputTables();
            updateModel();
        }

        function serializeState() {
            return {
                deviceInfo: deviceInfo,
                embodiedEmissionsKgCo2e: embodiedEmissionsKgCo2e,
                powerW: powerW,
                dutyCycle6h: dutyCycle6h,
                compute: compute,
                llms: llms,
                percentage: percentage
            };
        }

        function deserializeState(stateObj) {
            console.log("deserializing", stateObj.deviceInfo);
            if (stateObj.deviceInfo) Object.assign(deviceInfo, stateObj.deviceInfo);
            if (stateObj.embodiedEmissionsKgCo2e) Object.assign(embodiedEmissionsKgCo2e, stateObj.embodiedEmissionsKgCo2e);
            if (stateObj.powerW) Object.assign(powerW, stateObj.powerW);
            if (stateObj.dutyCycle6h) Object.assign(dutyCycle6h, stateObj.dutyCycle6h);
            if (stateObj.compute) Object.assign(compute, stateObj.compute);
            if (stateObj.llms) Object.assign(llms, stateObj.llms);
            if (stateObj.percentage) percentage = stateObj.percentage;
        }

        function updateURL() {
            const state = serializeState();
            const stateJson = JSON.stringify(state);
            const base64State = btoa(stateJson); // Base64 encode to avoid quoting issues
            const newUrl = window.location.pathname + '?config=' + base64State;

            // Update URL without triggering page reload
            window.history.replaceState(null, '', newUrl);
        }

        function parseURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');

            if (configParam) {
                try {
                    const decodedState = atob(configParam); // Base64 decode
                    const stateObj = JSON.parse(decodedState);
                    deserializeState(stateObj);
                    createInputTables();
                    updateModel();
                    console.log('Loaded configuration from URL');
                } catch (error) {
                    console.warn('Failed to parse URL configuration:', error);
                }
            } else {
                resetParameters();
            }
        }

        function updateModel() {
            runModel();
            renderOutput();
            updateURL();
        }

        window.onload = function() {
            parseURL();
        };
    </script>
</body>
</html>
