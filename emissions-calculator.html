<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Emissions Calculator</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Override and extend existing styles for calculator-specific needs */
        .emissions-calculator {
            padding-left: var(--page-margin);
            padding-right: var(--page-margin);
            margin-top: 2.5rem;
            margin-bottom: 2.5rem;
        }
        
        @media(max-width: 700px) {
            .emissions-calculator {
                margin-top: 2rem;
                margin-bottom: 2rem;
            }
        }
        
        .calculator-section {
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            border: 1px solid rgba(var(--c-grey), 0.2);
            border-radius: 0.5rem;
            background: rgba(var(--c-white), 1);
        }
        
        @media(max-width: 700px) {
            .calculator-section {
                margin-bottom: 2rem;
                padding: 1rem;
            }
        }
        
        .section-title {
            font-size: 1.125rem;
            line-height: 1.4;
            font-weight: 600;
            color: rgba(var(--c-black), 1);
            margin-bottom: 1rem;
        }
        
        @media(max-width: 700px) {
            .section-title {
                font-size: 1rem;
            }
        }
        
        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        
        .parameter-table th,
        .parameter-table td {
            border: 1px solid rgba(var(--c-grey), 0.2);
            padding: 0.5rem;
            text-align: center;
            vertical-align: middle;
        }
        
        .parameter-table th {
            background-color: rgba(var(--c-grey-light), 1);
            font-weight: 600;
            font-size: 0.875rem;
            line-height: 1.4;
            color: rgba(var(--c-black), 1);
        }
        
        .parameter-table td:first-child {
            text-align: left;
            font-weight: 600;
            background-color: rgba(var(--c-grey-light), 0.5);
        }
        /* Hide the up/down arrows in numeric input fields */
        .parameter-table input::-webkit-outer-spin-button,
        .parameter-table input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Do the same for Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
        .parameter-table input {
            width: 100%;
            border: none;
            padding: 0.25rem 0.25rem 0.25rem 0.25rem;
            text-align: right;
            font-size: 0.875rem;
            background: transparent;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .parameter-table input:focus {
            background-color: rgba(var(--c-blue-light), 1);
            outline: none;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin: 2rem 0;
            padding: 1rem;
            background-color: rgba(var(--c-grey-light), 1);
            border-radius: 0.5rem;
        }
        
        .controls label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.5;
            font-weight: 400;
            color: rgba(var(--c-text-grey), 1);
        }
        
        .controls input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
        }
        
        .results-section {
            margin-top: 3rem;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        
        .results-table th,
        .results-table td {
            border: 1px solid rgba(var(--c-grey), 0.2);
            padding: 0.75rem;
            text-align: left;
        }
        
        .results-table th {
            background-color: rgba(var(--c-grey-light), 1);
            font-weight: 600;
            color: rgba(var(--c-black), 1);
        }
        
        .results-table td {
            color: rgba(var(--c-text-grey), 1);
        }
        
        .results-table tr:last-child td {
            font-weight: 600;
            color: rgba(var(--c-black), 1);
            background-color: rgba(var(--c-blue), 0.05);
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(var(--c-white), 1);
            border: 1px solid rgba(var(--c-grey), 0.2);
            border-radius: 0.5rem;
        }
        
        @media(max-width: 700px) {
            .chart-container {
                height: 300px;
                padding: 1rem;
            }
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
        }
        
        @media(max-width: 900px) {
            .two-column {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        /* Use site's button styles */
        .rerun-btn {
            background-color: rgba(var(--c-blue), 1);
            color: rgba(var(--c-white), 1);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 100px;
            cursor: pointer;
            font-size: 0.875rem;
            line-height: 1.5;
            font-weight: 400;
            transition: background-color 0.2s ease-in-out;
        }
        
        .rerun-btn:hover {
            background-color: rgba(var(--c-blue), 0.8);
        }
        
        @media(max-width: 700px) {
            .rerun-btn {
                font-size: 0.75rem;
            }
        }
        
        /* Header with logo styling */
        .header-with-logo {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .uzh-logo {
            height: 4rem;
            width: auto;
            flex-shrink: 0;
        }
        
        .header-title {
            flex: 1;
            text-align: center;
            font-size: 2rem;
            line-height: 1.2;
            font-weight: 600;
            margin: 0;
            color: rgba(var(--c-black), 1);
        }
        
        @media(max-width: 700px) {
            .header-with-logo {
            }
            
            .uzh-logo {
                height: 3rem;
            }
            
            .header-title {
                font-size: 1.5rem;
            }
        }
        
        /* Collapsible table functionality */
        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .expand-toggle {
            background: none;
            border: none;
            font-size: 1rem;
            color: rgba(var(--c-blue), 1);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            user-select: none;
        }
        
        .expand-toggle:hover {
            background-color: rgba(var(--c-blue), 0.1);
        }
        
        .expand-toggle:focus {
            outline: 2px solid rgba(var(--c-blue), 0.5);
        }
        
        .additional-columns {
            display: none;
        }
        
        .additional-columns.visible {
            display: table-cell;
        }
        
        .additional-headers {
            display: none;
        }
        
        .additional-headers.visible {
            display: table-cell;
        }
        
        @media(max-width: 700px) {
            .expand-toggle {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <main>
        <div class="emissions-calculator">
            <!-- Page Title using UZH typography -->
            <div class="l-SiteWidth">
                <div class="header-with-logo">
                    <img src="assets/uzh_logo.svg" alt="UZH Logo" class="uzh-logo">
                    <h1 class="t-text-h1 header-title">IT Emissions Calculator</h1>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="l-SiteWidth">
                
                <!-- Three column layout for Device Population, Embodied Emissions, and Power Consumption -->
                <div class="three-column">
                    <section class="calculator-section">
                        <div class="table-header">
                            <h2 class="section-title">Device Population</h2>
                        </div>
                        <table class="parameter-table" id="device-table"></table>
                   </section>

                    <section class="calculator-section">
                        <div class="table-header">
                            <h2 class="section-title">Embodied Emissions (kg CO2e)</h2>
                            <button class="expand-toggle" onclick="toggleTableExpansion('embodied-table')" id="embodied-toggle">&gt;&gt;</button>
                        </div>
                        <table class="parameter-table" id="embodied-table"></table>
                    </section>
                    
                    <section class="calculator-section">
                        <div class="table-header">
                            <h2 class="section-title">Power Consumption (W)</h2>
                            <button class="expand-toggle" onclick="toggleTableExpansion('power-table')" id="power-toggle">&gt;&gt;</button>
                        </div>
                        <table class="parameter-table" id="power-table"></table>
                    </section>
                </div>
                
                <!-- Two Column Layout for Data Center and Cloud -->
                <div class="two-column">
                    <section class="calculator-section">
                        <h2 class="section-title">Data Center Parameters</h2>
                        <table class="parameter-table" id="datacenter-table"></table>
                    </section>
                    
                    <section class="calculator-section">
                        <h2 class="section-title">Cloud Parameters</h2>
                        <table class="parameter-table" id="cloud-table"></table>
                    </section>
                </div>
                
                <!-- Two Column Layout for LLM Parameters -->
                <div class="two-column">
                    <section class="calculator-section">
                        <h2 class="section-title">LLM Usage</h2>
                        <table class="parameter-table" id="llm-usage-table"></table>
                    </section>
                    
                    <section class="calculator-section">
                        <h2 class="section-title">LLM Power</h2>
                        <table class="parameter-table" id="llm-power-table"></table>
                    </section>
                </div>
                
                <!-- Controls -->
                <div class="controls">
                    <label>
                        <input type="checkbox" id="stocastic-checkbox"> 
                        <span>Stochastic</span>
                    </label>
                    <button class="rerun-btn" onclick="updateDevices()">Rerun Calculation</button>
                </div>
                
                <!-- Results Section -->
                <section class="results-section">
                    <h2 class="t-text-h2" style="margin-bottom: 1.5rem;">Results</h2>
                    
                    <table class="results-table" id="results-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Embodied (kg CO2e)</th>
                                <th>Usage (kg CO2e)</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                        </tbody>
                    </table>
                    
                    <div class="chart-container">
                        <canvas id="emissions-chart"></canvas>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let stochastic = false;
        let devices = {};
        let emissionsIntensity = {};
        let cloudInstances = 0;
        let llmQueries = null;
        let chart = null;

        // Data structures (converted from Python)
        const people = {
            'uzh population': {
                'students': 28000,
                'staff': 10000,
            }
        };

        const deviceInfo = {
            'laptops': { 
                'lifetime': 4,
                'count': 32000,
            },
            'desktops': { 
                'lifetime': 6,
                'count': 150,
            },
            'servers': { 
                'lifetime': 5,
                'count': 1028,
            },
            'smartphones': { 
                'lifetime': 3,
                'count': 32000,
            },
            'wall displays': {
                'lifetime': 6,
                'count': 360,
            },
            'monitors': { 
                'lifetime': 6,
                'count': 10325,
            },
            'printers': { 
                'lifetime': 6,
                'count': 1000,
            },
        };

        const embodiedEmissionsKgCo2e = {
            'laptops': {
                'average': 244,
                'stdev': 128,
                'lower_bound': 104,
                'upper_bound': 372,
            },
            'desktops': {
                'average': 289,
                'stdev': 80,
                'lower_bound': 209,
                'upper_bound': 403,
            },
            'servers': {
                'average': 1252,
                'stdev': 330,
                'lower_bound': 383,
                'upper_bound': 1582,
            },
            'smartphones': {
                'average': 50,
                'stdev': 10,
                'lower_bound': 30,
                'upper_bound': 70,
            },
            'monitors': {
                'average': 344,
                'stdev': 50,
                'lower_bound': 294,
                'upper_bound': 394,
            },
            'wall displays': {
                'average': 753,
                'stdev': 109,
                'lower_bound': 644,
                'upper_bound': 862,
            },
            'printers': {
                'average': 1167,
                'stdev': 200,
                'lower_bound': 967,
                'upper_bound': 1367,
            },
        };

        const powerW = {
            'laptops': {
                'average': 30,
                'stdev': 5,
                'lower_bound': 20,
                'upper_bound': 40,
                'standby': 1,
            },
            'desktops': {
                'average': 100,
                'stdev': 20,
                'lower_bound': 60,
                'upper_bound': 200,
                'standby': 1,
            },
            'servers': {
                'average': 400,
                'stdev': 100,
                'lower_bound': 200,
                'upper_bound': 600,
                'standby': 1,
            },
            'smartphones': {
                'average': 5,
                'stdev': 2,
                'lower_bound': 3,
                'upper_bound': 7,
                'standby': 0,
            },
            'monitors': {
                'average': 50,
                'stdev': 10,
                'lower_bound': 30,
                'upper_bound': 90,
                'standby': 1,
            },
            'wall displays': {
                'average': 250,
                'stdev': 50,
                'lower_bound': 150,
                'upper_bound': 350,
                'standby': 1,
            },
            'printers': {
                'average': 1000,
                'stdev': 200,
                'lower_bound': 600,
                'upper_bound': 1400,
                'standby': 90,
            },
        };

        const dataCenter = {
            'DC PUE': {
                'Value x100': 200,
            },
        };

        const cloudData = {
            'cloud': {
                '% servers in cloud': 0,
                'cloud server/local server': 1,
                'embodied kg CO2e/y': 97,
                'usage kg CO2e/y': 31,
                'PUE x100': 110,
            }
        };

        const llmUsage = {
            'LLM daily user queries': {
                'average': 15,
                'stdev': 5,
                'lower_bound': 0,
                'upper_bound': 30,
            },
        };

        const llmPower = {
            'LLM power': {
                'average query Wh': 3.5,
                'emissions intensity g CO2e / kWh': 226,
                'training ovhd %': 40,
            },
        };

        const dutyCycle6h = {
            'laptops': [0.1, 0.5, 1.0, 0.3],
            'desktops': [0.1, 0.5, 1.0, 0.3],
            'servers': [0.8, 0.8, 0.8, 0.8],
            'smartphones': [0.0, 0.0, 0.0, 0.5],
            'monitors': [0.1, 0.5, 1.0, 0.3],
            'wall displays': [0.0, 0.3, 0.6, 0.1],
            'printers': [0.0, 0.0, 0.01, 0.0],
        };

        // Emissions class
        class Emissions {
            static gco2PerKwhByHours = {
                'ch': [63, 58, 58, 52, 49, 47, 45, 45, 49, 54, 62, 63]
            };

            static atHour(hour, country) {
                return this.gco2PerKwhByHours[country][Math.floor(hour / 2)];
            }

            static average(country) {
                const values = this.gco2PerKwhByHours[country];
                return values.reduce((a, b) => a + b, 0) / values.length;
            }
        }

        // Utility functions
        function truncatedNormal(mu, sigma, minValue, maxValue, n) {
            if (n === 0) return [];
            if (!stochastic) return Array(n).fill(mu);
            
            const results = [];
            for (let i = 0; i < n; i++) {
                let value;
                do {
                    // Box-Muller transform for normal distribution
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    value = mu + sigma * z0;
                } while (value < minValue || value > maxValue);
                results.push(Math.floor(value));
            }
            return results;
        }

        // Generate multi-column collapsible input tables
        function createCollapsibleTable(tableId, data, all_params, default_display_params, callback) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';

            // Check that each row of data contains all_params
            Object.keys(data).forEach(key => {
                all_params.forEach(param => {
                    if (!data[key].hasOwnProperty(param)) {
                        throw new Error(`Data does not contain parameter ${param}`);
                    }
                });
            });
            
            // Headers for all_params, but only display default_display_params
            const headerRow = document.createElement('tr');
            headerRow.appendChild(document.createElement('th')); // Empty cell for row
            all_params.forEach(param => {
                const th = document.createElement('th');
                th.textContent = param;
                headerRow.appendChild(th);
                if (!default_display_params.includes(param)) {
                    th.className = 'additional-headers';
                }
            });
            table.appendChild(headerRow);
            
            // Create rows
            Object.keys(data).forEach(key => {
                const row = document.createElement('tr');
                
                // Row name cell
                const deviceCell = document.createElement('td');
                deviceCell.textContent = key;
                row.appendChild(deviceCell);
                
                all_params.forEach(param => {
                    const cell = document.createElement('td');
                    if (!default_display_params.includes(param)) {
                        cell.className = 'additional-columns';
                    }
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = data[key][param] || 0;
                    input.addEventListener('change', (e) => {
                        data[key][param] = parseFloat(e.target.value) || 0;
                        if (callback) callback();
                    });
                    cell.appendChild(input);
                    row.appendChild(cell);
                });
                table.appendChild(row);
            });
        }

        // Create key-value input tables
        function createKeyValueTable(tableId, data, callback) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';
            
            // Create header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Parameter</th><th>Value</th>';
            table.appendChild(headerRow);
            
            // For nested data structures like cloudData['cloud'], extract the inner object
            let params = data;
            if (Object.keys(data).length === 1) {
                const firstKey = Object.keys(data)[0];
                if (typeof data[firstKey] === 'object' && !Array.isArray(data[firstKey])) {
                    params = data[firstKey];
                }
            }
            
            // Create rows for each parameter
            Object.keys(params).forEach(paramKey => {
                const row = document.createElement('tr');
                
                // Parameter name cell
                const keyCell = document.createElement('td');
                keyCell.textContent = paramKey;
                row.appendChild(keyCell);
                
                // Value input cell
                const valueCell = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.value = params[paramKey];
                input.addEventListener('change', (e) => {
                    params[paramKey] = parseFloat(e.target.value) || 0;
                    if (callback) callback();
                });
                valueCell.appendChild(input);
                row.appendChild(valueCell);
                
                table.appendChild(row);
            });
        }

        // Toggle table expansion
        function toggleTableExpansion(tableId) {
            const table = document.getElementById(tableId);
            const toggle = document.getElementById(tableId.replace('-table', '-toggle'));
            
            const additionalHeaders = table.querySelectorAll('.additional-headers');
            const additionalColumns = table.querySelectorAll('.additional-columns');
            
            const isExpanded = additionalHeaders.length > 0 && additionalHeaders[0].classList.contains('visible');
            
            if (isExpanded) {
                // Collapse
                additionalHeaders.forEach(el => el.classList.remove('visible'));
                additionalColumns.forEach(el => el.classList.remove('visible'));
                toggle.textContent = '>>';
            } else {
                // Expand
                additionalHeaders.forEach(el => el.classList.add('visible'));
                additionalColumns.forEach(el => el.classList.add('visible'));
                toggle.textContent = '<<';
            }
        }

        // Initialize all input tables
        function initializeTables() {
            createCollapsibleTable('embodied-table', embodiedEmissionsKgCo2e, ["average", "stdev", "lower_bound", "upper_bound"], ["average"], updateDevices);
            createCollapsibleTable('power-table', powerW, ["average", "stdev", "lower_bound", "upper_bound", "standby"], ["average", "standby"], updateDevices);
            createCollapsibleTable('device-table', deviceInfo, ["count", "lifetime"], ["count", "lifetime"], updateDevices);
            createKeyValueTable('datacenter-table', dataCenter, updateDevices);
            createKeyValueTable('cloud-table', cloudData, updateDevices);
            createCollapsibleTable('llm-usage-table', llmUsage, ["average", "stdev", "lower_bound", "upper_bound"], ["average"], updateDevices);
            createKeyValueTable('llm-power-table', llmPower, updateDevices);
        }

        // Generate device instances
        function generateDevices() {
            devices = {};
            emissionsIntensity = {};
            
            Object.keys(deviceInfo).forEach(device => {
                devices[device] = {};
                
                let n = deviceInfo[device]['count'];
                if (device === 'servers') {
                    cloudInstances = Math.floor(cloudData['cloud']['% servers in cloud'] * n / 100);
                    n -= cloudInstances;
                }
                
                const stats = embodiedEmissionsKgCo2e[device];
                devices[device]['annual_embodied_emissions'] = truncatedNormal(
                    stats['average'], stats['stdev'], stats['lower_bound'], stats['upper_bound'], n
                ).map(x => x / deviceInfo[device]['lifetime']);
                
                devices[device]['power_w'] = truncatedNormal(
                    powerW[device]['average'], powerW[device]['stdev'], 
                    powerW[device]['lower_bound'], powerW[device]['upper_bound'], n
                );
                
                devices[device]['standby_w'] = Array(n).fill(powerW[device]['standby']);
                
                // Compute emissions intensity
                const dutyCycle = dutyCycle6h[device];
                const r = Math.floor(24 / dutyCycle.length);
                emissionsIntensity[device] = [];
                for (let i = 0; i < 24; i++) {
                    const cycleIndex = Math.floor(i / r);
                    const duty = dutyCycle[cycleIndex];
                    const emission = Emissions.atHour(i, 'ch');
                    emissionsIntensity[device].push(duty * emission);
                }
            });
            
            const q = llmUsage['LLM daily user queries'];
            const p = people['uzh population']['students'] + people['uzh population']['staff'];
            llmQueries = truncatedNormal(q['average'], q['stdev'], q['lower_bound'], q['upper_bound'], p);
        }

        // Calculate device emissions
        function deviceEmissionsKgco2e(device) {
            const intensitySum = emissionsIntensity[device].reduce((a, b) => a + b, 0);
            const powerSum = devices[device]['power_w'].reduce((a, b) => a + b, 0);
            const u = powerSum * intensitySum * 365 / (1000 * 1000);
            const m = devices[device]['annual_embodied_emissions'].reduce((a, b) => a + b, 0);
            return [u, m];
        }

        // Calculate cloud emissions
        function cloudEmissionsKgco2e() {
            const u = cloudInstances * cloudData['cloud']['cloud server/local server'] * 
                     cloudData['cloud']['usage kg CO2e/y'] * cloudData['cloud']['PUE x100'] / 100;
            const m = cloudInstances * cloudData['cloud']['cloud server/local server'] * 
                     cloudData['cloud']['embodied kg CO2e/y'];
            return [u, m];
        }

        // Calculate LLM emissions
        function llmEmissionsKgco2e() {
            const e = llmPower['LLM power']['average query Wh'];
            const i = llmPower['LLM power']['emissions intensity g CO2e / kWh'];
            const queriesSum = llmQueries.reduce((a, b) => a + b, 0);
            const u = queriesSum * 365 * e * i / (1000 * 1000);
            const m = u * llmPower['LLM power']['training ovhd %'] / 100;
            return [u, m];
        }

        // Update results display
        function refreshOutput() {
            let total = 0;
            const data = [];
            
            // Device emissions
            Object.keys(deviceInfo).forEach(device => {
                const [u, m] = deviceEmissionsKgco2e(device);
                total += u + m;
                data.push({
                    category: device,
                    embodied: m,
                    usage: u
                });
            });
            
            // DC cooling
            const [serverU] = deviceEmissionsKgco2e('servers');
            const dcCoolingU = serverU * (dataCenter['DC PUE']['Value x100'] - 100) / 100;
            data.push({
                category: 'DC cooling',
                embodied: null,
                usage: dcCoolingU
            });
            total += dcCoolingU;
            
            // Cloud
            const [cloudU, cloudM] = cloudEmissionsKgco2e();
            data.push({
                category: 'Cloud',
                embodied: cloudM,
                usage: cloudU
            });
            total += cloudU + cloudM;
            
            // LLM
            const [llmU, llmM] = llmEmissionsKgco2e();
            data.push({
                category: 'LLM',
                embodied: llmM,
                usage: llmU
            });
            total += llmU + llmM;
            
            // Total
            data.push({
                category: 'Total',
                embodied: null,
                usage: total
            });
            
            // Update table
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.category}</td>
                    <td>${row.embodied !== null ? Math.round(row.embodied) : ''}</td>
                    <td>${Math.round(row.usage)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update chart
            updateChart(data.slice(0, -1)); // Exclude total row
        }

        // Update chart
        function updateChart(data) {
            const ctx = document.getElementById('emissions-chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            const labels = data.map(d => d.category);
            const embodiedData = data.map(d => d.embodied || 0);
            const usageData = data.map(d => d.usage || 0);
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Embodied (kg CO2e/y)',
                        data: embodiedData,
                        backgroundColor: 'rgba(0, 40, 165, 0.8)',
                        borderColor: 'rgba(0, 40, 165, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Usage (kg CO2e)',
                        data: usageData,
                        backgroundColor: 'rgba(0, 40, 165, 0.5)',
                        borderColor: 'rgba(0, 40, 165, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'CO2e Emissions Breakdown',
                            font: {
                                size: 16,
                                weight: 600
                            }
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Category'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'kg CO2e'
                            }
                        }
                    }
                }
            });
        }

        // Main update function
        function updateDevices() {
            generateDevices();
            refreshOutput();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTables();
            
            // Read initial checkbox state before first calculation
            stochastic = document.getElementById('stocastic-checkbox').checked;
            
            // Set up stochastic checkbox
            document.getElementById('stocastic-checkbox').addEventListener('change', function(e) {
                stochastic = e.target.checked;
            });
            
            // Initial calculation
            updateDevices();
        });
    </script>
</body>
</html> 